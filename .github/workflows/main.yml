name: Build Redis Server 7.2.11 on RHEL 7.9

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发工作流

jobs:
  build:
    # 使用 RHEL 7.9 环境
    runs-on: ubuntu-latest
    container:
      image: redhat/ubi7:7.9
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up build environment
      run: |
        # 安装必要的构建工具和依赖
        yum -y install wget make gcc pkgconfig
        
    - name: Cache Redis source
      uses: actions/cache@v3
      with:
        path: redis-7.2.11
        key: ${{ runner.os }}-redis-7.2.11-source
        
    - name: Download Redis 7.2.11 source
      run: |
        if [ ! -d "redis-7.2.11" ]; then
          wget https://github.com/redis/redis/archive/7.2.11.tar.gz
          tar xzf 7.2.11.tar.gz
        fi
        
    - name: Build Redis
      run: |
        cd redis-7.2.11
        make MALLOC=libc  # 使用 libc malloc 以避免 jemalloc 相关问题
        
    - name: Upload Redis binary as artifact
      uses: actions/upload-artifact@v4
      with:
        name: redis-server-7.2.11-rhel7.9
        path: redis-7.2.11/src/redis-server
        
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: Redis Server 7.2.11 (RHEL 7.9)
        draft: false
        prerelease: false
        files: |
          redis-7.2.11/src/redis-server
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
